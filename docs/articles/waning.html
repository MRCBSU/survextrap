<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="survextrap">
<title>Treatment effect waning in survextrap • survextrap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Treatment effect waning in survextrap">
<meta property="og:description" content="survextrap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a>
    <a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a>
    <a class="dropdown-item" href="../articles/priors.html">Priors in survextrap models</a>
    <a class="dropdown-item" href="../articles/waning.html">Treatment effect waning in survextrap</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Treatment effect waning in survextrap</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2023-03-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/waning.Rmd" class="external-link"><code>vignettes/waning.Rmd</code></a></small>
      <div class="d-none name"><code>waning.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="treatment-effect-waning-principles">Treatment effect waning: principles<a class="anchor" aria-label="anchor" href="#treatment-effect-waning-principles"></a>
</h2>
<p>Suppose we have short-term data, say from a trial of a treatment
against a control. The trial data is assumed to be representative of the
treatment effect in the short term. We may also have long-term data that
gives information about the survival in the control group. However we do
not believe that the effect of the treatment will continue. In the long
term, we suppose the treatment effect “wanes” or diminishes, so that
over time the treatment and control group will have similar risks.</p>
<p>How is this done in <code>survextrap</code>? Essentially:</p>
<ul>
<li><p>We fit a <code>survextrap</code> (M-spline) model that combines
the short-term data with the long-term data on the control group. From
this model, we estimate the short-term treatment effect (e.g. with a
proportional hazards model), and the long-term survival in the control
group.</p></li>
<li><p>However, we do not want to use the model directly to estimate
long-term survival in the treatment group, because it relies on the
assumption that the hazard ratio in the short term continues in the
longer term. Instead, to predict long-term survival in the <em>treatment
group</em> we assume that the treatment effect <em>wanes</em> over some
time interval from <span class="math inline">\(t_{min}\)</span> to <span class="math inline">\(t_{max}\)</span>, where <span class="math inline">\(t_{min}\)</span> is after the follow-up period of
the trial.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="waning-model">Waning model<a class="anchor" aria-label="anchor" href="#waning-model"></a>
</h2>
<p>Specifically, to predict the long-term hazard <span class="math inline">\(h(t | x=1)\)</span> in the treated group, we
assume:</p>
<ul>
<li><p>Between time <span class="math inline">\(t=0\)</span> and <span class="math inline">\(t=t_{min}\)</span>, <span class="math inline">\(h(t | x=1)\)</span> is equal to the hazard in the
treated group <span class="math inline">\(x=1\)</span>, estimated from
the model.</p></li>
<li><p>After time <span class="math inline">\(t=t_{max}\)</span>, <span class="math inline">\(h(t | x=1)\)</span> is equal to the hazard in the
control group <span class="math inline">\(h(t | x=0)\)</span>, estimated
from the model.</p></li>
<li>
<p>During the interval between <span class="math inline">\(t =
t_{min}\)</span> and <span class="math inline">\(t = t_{max}\)</span>,
the log hazard ratio <span class="math inline">\(\log(hr(t)) =
\log(h(t|x=1) | h(t|x=0))\)</span> diminishes linearly between the log
hazard ratio <span class="math inline">\(\log(hr(t_{min}))\)</span> at
<span class="math inline">\(t_{min}\)</span>, estimated from the model,
and zero at <span class="math inline">\(t_{max}\)</span>. That is, <span class="math inline">\(\log(hr(t)) = w \log(hr(t_{min}))\)</span>, where
<span class="math inline">\(w = (t - t_{min}) / (t_{max} -
t_{min})\)</span>.</p>
<p>Hence the predicted hazard for the treated group at <span class="math inline">\(t\)</span> is defined from the M-spline model as
<span class="math inline">\(h(t|x=1) = h(t | x=0) hr(t)\)</span>, where
<span class="math inline">\(h(t|x=0)\)</span> comes from the fitted
M-spline model.</p>
</li>
<li><p>A piecewise-constant approximation, on a fine grid, is then
imposed on the hazard within the waning period to allow easy calculation
of the cumulative hazard, survival and related quantities.</p></li>
</ul>
<p>Note that the waning assumption is implemented during
<em>prediction</em> from the fitted model, rather than as a “prior” or
structural assumption used during model fitting. The baseline log hazard
ratio at <span class="math inline">\(t_{min}\)</span> is inferred from
the M-spline model, short-term data and any long-term data provided.
Then when requesting predictions of, e.g., survival curves, hazard
curves or mean survival times from this fitted model, we can optionally
request that over some interval <span class="math inline">\(t_{min},t_{max}\)</span> the log hazard ratio for
some covariate changes linearly between the value estimated from the
model and some “null” value.</p>
<p>The fitted M-spline model does not necessarily need to be a
proportional hazards model to use treatment waning. If the fitted model
is non-proportional hazards, the hazard ratio will be non-constant
between time 0 and <span class="math inline">\(t_{min}\)</span>, then
wane between the value at <span class="math inline">\(t_{min}\)</span>
and zero at <span class="math inline">\(t_{max}\)</span>.</p>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>For clarity here, we subset the example data to only two out of the
three treatment groups: observation-only and levamisole.</p>
<p>First we fit a survextrap model (arbitrarily, for this example, an
M-spline model with 5 basis terms).</p>
<p>We extrapolate the survival and hazard curves up to 10 years under a
naive assumption of proportional hazards beyond the end of follow-up (3
years).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="va">colons2</span> <span class="op">&lt;-</span> <span class="va">colons</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span>, <span class="st">"Lev"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rxph_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">rx</span>, data<span class="op">=</span><span class="va">colons2</span>, </span>
<span>                       fit_method<span class="op">=</span><span class="st">"opt"</span>, mspline<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxph_mod</span>, tmax<span class="op">=</span><span class="fl">10</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="waning_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>To predict from this model under a waning treatment effect we must
define the following:</p>
<ul>
<li><p><code>wane_period</code>: a vector containing the start and end
of the period over which the effect wanes</p></li>
<li><p><code>newdata</code>: the covariate values that define the hazard
under the “full” effect (before waning starts)</p></li>
<li><p><code>newdata0</code>: the covariate values that define the
hazard under the “null” effect (after waning finishes)</p></li>
</ul>
<p>Optionally we can also supply <code>wane_nt</code>, which defines the
number of intervals to use for the grid approximation to the hazard
within the waning period. This defaults to 10, which I’d expect to be
sufficient in practice.</p>
<p>These things are supplied as arguments to the functions
<code>survival</code>, <code>hazard</code> and <code>rmst</code>, and
the <code>plot</code> and <code>mean</code> methods for survextrap
objects.</p>
<p>In this example, we predict the survival and hazard over 10 years for
the treated and control groups. The treated group is assumed to
experience treatment effect waning - so that between 5 and 10 years,
their log hazard changes linearly between the modelled hazard of the
treated group and the modelled hazard of the control group.</p>
<p>To obtain predictions for both groups, we first define the “full” and
“null” covariate values, as data frames with two rows, one for the
treated group and one for the control group. Note for the control group,
the “full” and “null” covariate values are the same.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lev"</span>,<span class="st">"Obs"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nd_null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span>,<span class="st">"Obs"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then supply these as arguments to the <code>plot</code> method,
along with a definition of the waning period (5 to 10 years), to
illustrate the survival and hazard trajectories for each group under
this waning model. Note how the hazard curves converge over the waning
period. The survival curves have only just started to converge - the
effects of the waning on survival would be more noticeable over longer
extrapolation periods (say 30-40 years).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxph_mod</span>, tmax<span class="op">=</span><span class="fl">10</span>, wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, niter<span class="op">=</span><span class="fl">1000</span>, </span>
<span>     newdata <span class="op">=</span> <span class="va">nd_full</span>, newdata0 <span class="op">=</span> <span class="va">nd_null</span><span class="op">)</span></span></code></pre></div>
<p><img src="waning_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>We also compare the restricted mean survival times (up to 50 years)
with and without treatment waning. The consequence of the waning
treatment effect is to reduce this long term mean survival time under
the treated group by about three years. (Combining waning with
computation of the restricted mean is computationally intensive, so in
this illustration, we only use a sample of 20 from the posterior
distribution).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t<span class="op">=</span><span class="fl">50</span>, niter<span class="op">=</span><span class="fl">100</span>, newdata<span class="op">=</span><span class="va">nd_full</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    rx variable  t median 2.5% 97.5%</span></span>
<span><span class="co">## 1 Lev     rmst 50   14.7  3.5    33</span></span>
<span><span class="co">## 2 Obs     rmst 50    9.4  3.1    24</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t<span class="op">=</span><span class="fl">50</span>, niter<span class="op">=</span><span class="fl">20</span>, newdata<span class="op">=</span><span class="va">nd_full</span>, newdata0<span class="op">=</span><span class="va">nd_null</span>, wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    rx variable  t median 2.5% 97.5%</span></span>
<span><span class="co">## 1 Lev     rmst 50   12.4  3.3    31</span></span>
<span><span class="co">## 2 Obs     rmst 50    9.3  2.7    24</span></span></code></pre>
<div class="section level3">
<h3 id="distribution-utilities">Distribution utilities<a class="anchor" aria-label="anchor" href="#distribution-utilities"></a>
</h3>
<p>Distribution and random number generation functions for the “waning
effect” model are available as <code><a href="../reference/Survmspline_wane.html">psurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">Hsurvmspline_wane()</a></code>, <code><a href="../reference/Survmspline_wane.html">hsurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">dsurvmspline_wane()</a></code>, <code><a href="../reference/Survmspline_wane.html">qsurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">rsurvmspline_wane()</a></code>, to enable users to construct other
summaries or predictions from this model.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
