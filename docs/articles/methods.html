<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Details of methods behind survextrap • survextrap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Details of methods behind survextrap">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.16</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cetuximab.html">Case study of using survextrap: cetuximab for head and neck cancer</a></li>
    <li><a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a></li>
    <li><a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Priors in survextrap models</a></li>
    <li><a class="dropdown-item" href="../articles/sbc.html">Simulation-based calibration of survextrap</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Details of methods behind survextrap</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2025-02-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/methods.Rmd" class="external-link"><code>vignettes/methods.Rmd</code></a></small>
      <div class="d-none name"><code>methods.Rmd</code></div>
    </div>

    
    
<p>See the <a href="../index.html">README</a> for the design principles
of the package, and the <a href="examples.html">examples vignette</a>
for examples of how to fit models. A more formal account of the methods
is given in the preprint <a href="https://doi.org/10.1186/s12874-023-02094-1" class="external-link">paper</a>.</p>
<div class="section level2">
<h2 id="m-splines">M-splines<a class="anchor" aria-label="anchor" href="#m-splines"></a>
</h2>
<p>The axis of time is split into a set of regions defined by
<em>knots</em>. In the example below, the knots are located at the
integers from 1 to 10, as shown by the grid lines.</p>
<p>Each region is associated with a <em>cubic polynomial function</em>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">b_i(t)</annotation></semantics></math>,
known as a <em>basis</em> function. M-spline basis functions are defined
to be positive.</p>
<p>The hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t)</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
is defined by a <em>weighted sum</em> of the basis functions:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>η</mi><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>p</mi><mi>i</mi></msub><msub><mi>b</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t) = \eta \sum_i p_i b_i(t)</annotation></semantics></math></p>
<p>with</p>
<ul>
<li><p>weights
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>p</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">p_1,\ldots,p_n</annotation></semantics></math>
that sum to 1,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum_i p_i = 1</annotation></semantics></math>,
known as the <em>basis coefficients</em>.</p></li>
<li><p>a <em>scale</em> parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>η</mi><annotation encoding="application/x-tex">\eta</annotation></semantics></math>
that describes the average level of the hazard.</p></li>
</ul>
<div class="section level3">
<h3 id="standard-m-spline-basis">Standard M-spline basis<a class="anchor" aria-label="anchor" href="#standard-m-spline-basis"></a>
</h3>
<p>In the standard basis, 10 knots implies there are 13 basis functions.
Two of the basis functions have peaks at 0 and the upper knot, and the
others have peaks around the knot, diminishing to zero on either side.
See <a href="https://www.jstor.org/stable/2245395" class="external-link">Ramsay</a> for the
exact definitions of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">b_i(t)</annotation></semantics></math>.</p>
<p>The package provides a few functions
(e.g. <code><a href="../reference/mspline_plotdata.html">mspline_plotdata()</a></code>, <code><a href="../reference/plot_mspline.html">plot_mspline()</a></code>) to
illustrate M-spline bases. The actual computation of the basis is done
with the <a href="https://cran.r-project.org/web/packages/splines2/index.html" class="external-link">splines2</a>
package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">mspline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knots<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, degree<span class="op">=</span><span class="fl">3</span>, bsmooth<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">p_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs</a></span><span class="op">(</span><span class="va">mspline</span><span class="op">)</span></span>
<span><span class="va">p_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">13</span>, <span class="fl">13</span><span class="op">)</span></span>
<span><span class="va">haz_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_plotdata.html">mspline_plotdata</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">mspline</span><span class="op">$</span><span class="va">knots</span>, scale<span class="op">=</span><span class="fl">10</span>, coefs <span class="op">=</span> <span class="va">p_const</span>, bsmooth <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">mspline</span><span class="op">$</span><span class="va">knots</span>, bsmooth<span class="op">=</span><span class="cn">FALSE</span>, scale<span class="op">=</span><span class="fl">10</span>, coefs <span class="op">=</span> <span class="va">p_naive</span>, tmax<span class="op">=</span><span class="fl">11</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, data<span class="op">=</span><span class="va">haz_unif</span>, color<span class="op">=</span><span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">2</span>, y<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"h(t): coefficients `p_const`"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">1.5</span>, y<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"h(t): coefficients `p_naive`"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time t"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard rate"</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="smoothed-m-spline-basis">Smoothed M-spline basis<a class="anchor" aria-label="anchor" href="#smoothed-m-spline-basis"></a>
</h3>
<p>An alternative basis is provided which is smoother at the upper knot
(defined by having zero derivative and second derivative at this point).
This is selected by setting <code>bsmooth=TRUE</code> in the various
package functions for defining M-splines.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mspline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knots<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, degree<span class="op">=</span><span class="fl">3</span>, bsmooth<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">p_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs</a></span><span class="op">(</span><span class="va">mspline</span><span class="op">)</span></span>
<span><span class="va">p_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">11</span>, <span class="fl">11</span><span class="op">)</span></span>
<span><span class="va">haz_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_plotdata.html">mspline_plotdata</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">mspline</span><span class="op">$</span><span class="va">knots</span>, scale<span class="op">=</span><span class="fl">1</span>, </span>
<span>                             coefs <span class="op">=</span> <span class="va">p_const</span>, bsmooth <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">mspline</span><span class="op">$</span><span class="va">knots</span>, bsmooth<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>             scale<span class="op">=</span><span class="fl">1</span>, coefs <span class="op">=</span> <span class="va">p_naive</span>, tmax<span class="op">=</span><span class="fl">11</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, data<span class="op">=</span><span class="va">haz_unif</span>, </span>
<span>              color<span class="op">=</span><span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">2</span>, y<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"red"</span>, </span>
<span>             label<span class="op">=</span><span class="st">"h(t): coefficients `p_const`"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">1.5</span>, y<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"h(t): coefficients `p_naive`"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time t"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard rate"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="using-m-splines-to-represent-particular-hazard-shapes">Using M-splines to represent particular hazard shapes<a class="anchor" aria-label="anchor" href="#using-m-splines-to-represent-particular-hazard-shapes"></a>
</h2>
<p>The coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>
define how the hazard changes through time. If knots are equally spaced,
then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>
are nearly proportional to the hazard in the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th
region, so that if all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>
are equal, then the hazard is nearly constant (red line
<code>p_equal</code> in the figure). It is not exactly constant because
of the influence of the regions at either end of the space, whose
polynomial functions have a skewed shape.</p>
<p>To produce a practically constant hazard, we can search numerically
for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>
which minimise the variance of a selection of points
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
that span the area that we want to model. This search can be done
automatically in the package (red line <code>p_const</code> in the
figure).</p>
<p><strong>Extrapolation?</strong> To fully specify a parametric
time-to-event model, we have to define the hazard for times greater than
the time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mi>n</mi></msub><annotation encoding="application/x-tex">t_{n}</annotation></semantics></math>
of the highest knot, which is 10 in the example.</p>
<p>The model in <code>survextrap</code> simply assumes that the hazard
for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>&gt;</mo><msub><mi>t</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">t &gt; t_{n}</annotation></semantics></math>
is constant, the same as the hazard at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mi>n</mi></msub><annotation encoding="application/x-tex">t_{n}</annotation></semantics></math>.</p>
<p>Therefore, if you want to estimate survival over a period where you
think the hazard might not be constant, then you should make sure that
the highest spline knot
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mi>n</mi></msub><annotation encoding="application/x-tex">t_n</annotation></semantics></math>
is after the end of this period.</p>
<blockquote>
<p><strong>Sidenote</strong>. Another way to define the hazard beyond
the last knot would be to extrapolate the final basis polynomials. This
is how <a href="https://cran.r-project.org/web/packages/splines2/index.html" class="external-link">splines2</a>
would compute the basis outside the boundary, but this is not
implemented in <code>survextrap</code>. Although it would lead to a more
smoothly extrapolated hazard, it would be driven by data just before the
boundary, and would be making opaque assumptions about how the hazard
changes after the boundary. The idea behind the package is to make all
assumptions explicit as data or mechanisms.</p>
</blockquote>
<p>Examples of doing this with different kinds of data and knowledge are
given in <code><a href="../articles/examples.html">vignette("examples")</a></code>.</p>
<p>Another arbitrary example of an M-spline curve, more wiggly than the
one above:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>knots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>     coefs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>, <span class="fl">2</span>, <span class="fl">0.6</span><span class="op">)</span>, tmax<span class="op">=</span><span class="fl">10</span>, bsmooth<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="section level3">
<h3 id="why-not-other-kinds-of-spline">Why not other kinds of spline?<a class="anchor" aria-label="anchor" href="#why-not-other-kinds-of-spline"></a>
</h3>
<ul>
<li><p>The Royston/Parmar model (e.g. in <code>flexsurv</code>) uses a
natural cubic spline for the log cumulative hazard function. A
cumulative hazard is defined to be a non-decreasing function, but the
spline is not constrained. The constraint is handled during fitting the
model - spline coefficients which imply decreasing cumulative hazard
functions are rejected. This is inefficient. A worse problem for
Bayesian analysis of this model is that it is unclear how to specify
priors - a meaningful joint prior on the coefficients would have to rule
out invalid combinations.</p></li>
<li><p>We could also have placed an unrestricted spline, of any kind, on
the log hazard. The disadvantage with this is that the cumulative hazard
(required to obtain the likelihood for censored data) then has to be
evaluated by numerical integration, which is slow.</p></li>
<li><p>The advantage of putting an M-spline on the hazard is that it
respects the constraint that a hazard has to be non-negative, while it
can be integrated analytically to produce the cumulative
hazard.</p></li>
<li><p>A remaining disadvantage of M-splines is that they still rely on
a choice of knot locations. For modelling data, knots are generally
chosen to give equal amounts of data between the knots. The user just
has to define the number of knots. This approach generally works well in
practice.</p></li>
<li><p>There are many different kinds of arbitrarily-flexible model
(fractional polynomials, particular kinds of spline), which are all
designed to fit the data very well. In practice, they may differ in
their computational efficiency, and how easily we can construct priors
for their parameters. Priors will be influential in the places where
there are no data. Though for any model we can use simulation to
calibrate priors to meaningful beliefs - see the <a href="priors.html">priors vignette</a> for examples. For extrapolation,
we don’t want to rely on opaque nuances of the functional forms used in
specific model families. Splines are at least computationally and
conceptually simpler than other kinds of flexible model families,
e.g. Gaussian or Dirichlet processes.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="bayesspec">Bayesian model specification<a class="anchor" aria-label="anchor" href="#bayesspec"></a>
</h2>
<p>The <em>parameters</em> of the model,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>η</mi><annotation encoding="application/x-tex">\eta</annotation></semantics></math>,
are estimated from data using Bayesian inference.</p>
<p>The <em>flexibility</em> of the fitted model is determined by two
things.</p>
<ol style="list-style-type: lower-alpha">
<li><p>The number
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
and choice of knots. This determines the <em>maximum potential
flexibility</em> of the hazard function.</p></li>
<li><p>The <em>prior distribution</em> on the basis coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>.
This plays the role of <em>smoothing</em> the fitted hazard
function.</p></li>
</ol>
<p>The default approach taken by <code>survextrap</code> is to choose a
large number of knots and basis functions (the default is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">n=10</annotation></semantics></math>),
intended to accommodate all reasonable situations, and then
<em>estimate</em> the extent of smoothing needed from the data.</p>
<ul>
<li><p>With <em>more data</em>, the fitted curve is as flexible as
necessary to represent the data.</p></li>
<li><p>With <em>less data</em>, the fit is influenced more by the
prior.</p></li>
</ul>
<p>This is a smoother, Bayesian analogue of the common approach to
spline model selection based on choosing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
to give the model with the lowest AIC. It also similar in principle to
the “penalised likelihood” methods implemented in e.g. the
<code>mgcv</code> and <code>rstpm2</code> packages.</p>
<p>All priors in the package can be chosen by the user (within given
distribution families). See the <a href="priors.html">priors
vignette</a> for examples and advice for doing this. The defaults in the
package are all weakly informative, and should be reasonable if there
are enough data, but to promote transparency of the analysis it is
advised to think what priors might be reasonable and specify them
explicitly.</p>
</div>
<div class="section level2">
<h2 id="priorhaz">Prior distribution for the hazard curve<a class="anchor" aria-label="anchor" href="#priorhaz"></a>
</h2>
<p>A log-normal prior is used for the scale
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>η</mi><annotation encoding="application/x-tex">\eta</annotation></semantics></math>.
The default in the package is normal(0, 20) for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>η</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(\eta)</annotation></semantics></math>.</p>
<p>The prior for the basis coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>,
that describe the mass of the hazard in each region, is specified on the
multinomial logistic scale, since
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum_i p_i = 1</annotation></semantics></math>.
Define
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>i</mi></msub><mi>/</mi><msub><mi>p</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>γ</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">log(p_i / p_1) = \gamma_i</annotation></semantics></math>,
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>γ</mi><mn>1</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\gamma_1=0</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>γ</mi><mi>i</mi></msub><mo>=</mo><msub><mi>μ</mi><mi>i</mi></msub><mo>+</mo><mi>σ</mi><msub><mi>ϵ</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\gamma_i = \mu_i + \sigma\epsilon_i</annotation></semantics></math>,
for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>2</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">i = 2, \ldots, n</annotation></semantics></math>.
The prior has the following parameters:</p>
<ol style="list-style-type: lower-alpha">
<li><p><strong>Prior mean</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝛍</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mn>2</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>μ</mi><mi>n</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{\mu} = (\mu_2,\ldots,\mu_n)</annotation></semantics></math>.
By default, this is determined from the special set of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>
that result in a <em>constant hazard</em>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t)</annotation></semantics></math>.
See the <code><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs()</a></code> function in the package to
compute this.</p></li>
<li>
<p><strong>Prior variability</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
controls the smoothness of the fitted hazard curve.</p>
<ul>
<li><p>If
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\sigma=0</annotation></semantics></math>,
then we are certain that the hazard function (before being scaled by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>η</mi><annotation encoding="application/x-tex">\eta</annotation></semantics></math>)
is the one defined by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛍</mi><annotation encoding="application/x-tex">\boldsymbol{\mu}</annotation></semantics></math>.
By default this is a constant hazard.</p></li>
<li><p>Values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
around 1 favour wiggly curves, such that the fitted hazard curve is
driven mainly by the the observed data.</p></li>
<li><p>For <em>very</em> high values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>,
the hazard is dominated by a random one of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
basis functions, which will not typically be useful in
practice.</p></li>
</ul>
</li>
<li>
<p><strong>A “random effect”</strong>:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ϵ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\epsilon_i</annotation></semantics></math>,
which describes how much the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th
basis coefficient departs from the mean, compared to the other basis
coefficients. The default is an “exchangeable” model, with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϵ</mi><mi>i</mi></msub><mo>∼</mo><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>c</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\epsilon_i \sim Logistic(0,1)</annotation></semantics></math>,
so that the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\gamma_i</annotation></semantics></math>
are conditionally independent given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\mu_i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>.</p>
<p>An alternative, smoother model can be specified to relate the basis
coefficients, using a random walk that constrains the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\gamma_i</annotation></semantics></math>
closer to each other in time to be more similar to each other. This
model is generated as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϵ</mi><mn>1</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\epsilon_1=0</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϵ</mi><mi>i</mi></msub><mo>∼</mo><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>c</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ϵ</mi><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>w</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\epsilon_i \sim Logistic(\epsilon_{i-1}, w_i)</annotation></semantics></math>
for any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>≥</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">i \geq 2</annotation></semantics></math>.
The weight
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mi>i</mi></msub><annotation encoding="application/x-tex">w_i</annotation></semantics></math>
accounts for the difference in the time periods described by
coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i-1</annotation></semantics></math>.
This ensures that we are less inclined to allow hazard variations in
regions of time where the knots are more closely-spaced, leading to a
more realistically smooth function than if these weights were excluded.
The exact definition of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mi>i</mi></msub><annotation encoding="application/x-tex">w_i</annotation></semantics></math>
is given in <a href="https://arxiv.org/abs/2401.12640" class="external-link">Phillippo et
al. 2024</a>, following principles from <a href="https://arxiv.org/pdf/2201.06808" class="external-link">Li and Cao 2022</a>.</p>
</li>
</ol>
<blockquote>
<p><strong>Sidenote</strong>. This multinomial logistic distribution is
similar to a Dirichlet distribution for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>,
but is slightly better behaved for how MCMC estimation is done in Stan.
The interpretation of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
is not completely intuitive, but there is a function in the package
(<code>prior_hsd()</code>) to choose the prior on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
to match judgements about how much the hazard might vary over time.</p>
</blockquote>
<p>The plots below show samples from the prior distribution for the
hazard functions implied by two choices of the joint prior distribution
for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>η</mi><annotation encoding="application/x-tex">\eta</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>.
In both,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>η</mi><annotation encoding="application/x-tex">\eta</annotation></semantics></math>
is log normal(0,1), which supports hazard rates between about 0.1 and 7,
and the prior mean for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
is the special set that is centred around a constant hazard. The two
samples differ by the choice of prior variability.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>∼</mo><mi>G</mi><mi>a</mi><mi>m</mi><mi>m</mi><mi>a</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>40</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma \sim Gamma(2,40)</annotation></semantics></math>
strongly favours low values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>,
which forces the hazard to be nearly uniform, while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>∼</mo><mi>G</mi><mi>a</mi><mi>m</mi><mi>m</mi><mi>a</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\sigma \sim Gamma(2,1)</annotation></semantics></math>
allows a wide range of wiggly shapes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">mspline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span><span class="op">)</span></span>
<span><span class="va">p_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs</a></span><span class="op">(</span><span class="va">mspline</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prior_sample_hazard.html">plot_prior_hazard</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span>, tmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">knots</span><span class="op">)</span>, </span>
<span>                        coefs_mean <span class="op">=</span> <span class="va">p_mean</span>,</span>
<span>                        prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">40</span><span class="op">)</span>,      </span>
<span>                        prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                        nsim<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">sigma</span> <span class="op">~</span> <span class="st">" ~ Gamma(2,40)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prior_sample_hazard.html">plot_prior_hazard</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span>, tmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">knots</span><span class="op">)</span>, </span>
<span>                        coefs_mean <span class="op">=</span> <span class="va">p_mean</span>,</span>
<span>                        prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,       </span>
<span>                        prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                        nsim<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">sigma</span> <span class="op">~</span> <span class="st">"~ Gamma(2,1)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>By default, the package estimates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
as part of the full Bayesian model (with a gamma(2,1) prior), so that
uncertainty about the level of smoothness is accounted for.</p>
<p>If sampling is poor, then this alternative procedure might work - fit
the model in two steps (“empirical Bayes”):</p>
<ol style="list-style-type: decimal">
<li><p>A “training” model fit is perfomed, where a prior is placed on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>,
and the maximum a posteriori estimate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>σ</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat\sigma</annotation></semantics></math>
of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
is determined.</p></li>
<li><p>A “final” model is then fitted, in which
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
is fixed to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>σ</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat\sigma</annotation></semantics></math>,
giving the “optimal” amount of smoothness for the hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t)</annotation></semantics></math>.</p></li>
</ol>
<p>The default choices in the package seems to under-smooth in some
cases. Though it may not matter if the hazard function is
under-smoothed, if the purpose of the model is to estimate a quantity
that is an average over time (e.g. mean survival).</p>
<p>A sensible route to resolving these uncertainties might be use
cross-validation to assess and choose between model specifications. The
package provides an interface to the <a href="https://mc-stan.org/users/interfaces/loo" class="external-link">LOO-CV</a> method for
Bayesian cross-validation - though note that this only assesses fit to
the individual-level data, using the same principle as AIC.</p>
</div>
<div class="section level2">
<h2 id="choice-of-knots-when-modelling-data">Choice of knots when modelling data<a class="anchor" aria-label="anchor" href="#choice-of-knots-when-modelling-data"></a>
</h2>
<p>By default, internal knots are placed at the quantiles of the vector
comprising the uncensored survival times in the individual level data,
using 10 basis functions, and the smoothed version of the basis. Users
can override these defaults however, and use any number of knots, placed
at any position.</p>
<p>In particular, the default is to place the highest knot at the
highest follow-up time in the data. This default should be overridden if
you want to extrapolate, and you think the hazard might change. A
sensible guide is to place the upper knot at the latest time that you
are interested in modelling. Beyond this time, you either think the
hazard will not change, or any changes in the hazard do not matter for
whatever purpose the model is used for.</p>
<p>With external data, it is advisable to place knots manually to cover
the time period of the data, the time period you want to estimate
survival over, and to enable variations over time in the hazard to be
estimated if the data allow this. Some examples are given in the <a href="https://chjackson.github.io/survextrap/articles/cetuximab.html">cetuximab
case study</a>.</p>
<p>The priors should then be chosen to give a low probability that the
hazard varies outside the range thought reasonable, e.g. in terms of
orders of magnitude. See the <a href="priors.html">priors vignette</a>
for detailed guidance on this.</p>
<p>The default number of knots does not depend on the absolute amount of
data. With small datasets, we will be relying more strongly on the prior
to do the smoothing. We could assess whether this matters by using
LOO-CV cross-validation.</p>
<p>With external data, we want a choice of knots outside the data which
we can defend as allowing a reasonable range of shapes for the hazard
function, prior to observing the data.</p>
</div>
<div class="section level2">
<h2 id="effect-of-covariates-on-the-hazard">Effect of covariates on the hazard<a class="anchor" aria-label="anchor" href="#effect-of-covariates-on-the-hazard"></a>
</h2>
<p>In <code>survextrap</code>, the hazard may also depend on a vector of
covariates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math>
as well as time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
and we write the hazard as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t,\boldsymbol{x})</annotation></semantics></math>.</p>
<div class="section level3">
<h3 id="proportional-hazards-model">Proportional hazards model<a class="anchor" aria-label="anchor" href="#proportional-hazards-model"></a>
</h3>
<p>The default model fitted is a <em>proportional hazards model</em>,
where the scale parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>η</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\eta(\boldsymbol{x})</annotation></semantics></math>
is defined as a log-linear function of a vector of covariates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math>.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>η</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>𝛃</mi><mi>T</mi></msup><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex"> \eta(\boldsymbol{x}) = \exp(\boldsymbol{\beta}^T \boldsymbol{x}) </annotation></semantics></math></p>
<p>In this model, the ratio between the hazards
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t,\boldsymbol{x})</annotation></semantics></math>
at two different values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math>
is constant with respect to time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
The <em>hazard ratios</em> (i.e. between a value of 1 and 0 for each
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math>)
are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝛃</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">exp(\boldsymbol{\beta})</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="nonprop">Flexible, non-proportional hazards model<a class="anchor" aria-label="anchor" href="#nonprop"></a>
</h3>
<p>An alternative <em>non-proportional hazards</em> model is available.
This is achieved by also modelling the spline coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>
as functions of covariates, in addition to the log-linear model on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>η</mi><annotation encoding="application/x-tex">\eta</annotation></semantics></math>.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>i</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><msub><mi>p</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>γ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">(</mo><mrow><mi>𝐱</mi><mo stretchy="false" form="postfix" mathvariant="bold">)</mo></mrow></mrow><annotation encoding="application/x-tex">log(p_i(\boldsymbol{x}) / p_1(\boldsymbol{x})) = \gamma_i(\boldsymbol{x)} </annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>γ</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">(</mo><mrow><mi>𝐱</mi><mo stretchy="false" form="postfix" mathvariant="bold">)</mo></mrow><mo>∼</mo><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>c</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>i</mi></msub><mo>+</mo><msubsup><mi>𝛅</mi><mi>i</mi><mi>T</mi></msubsup><mi>𝐱</mi><mo>,</mo><mi>σ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="1.0em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>=</mo><mn>2</mn><mo>,</mo><mi>.</mi><mi>.</mi><mi>.</mi><mo>,</mo><mi>n</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="1.0em"></mspace><msub><mi>δ</mi><mn>1</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex"> \gamma_i(\boldsymbol{x)} \sim Logistic(\mu_i + \boldsymbol{\delta}^T_i \boldsymbol{x}, \sigma) \quad (i=2,...,n), \quad \delta_1 = 0 </annotation></semantics></math></p>
<p>The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>th
element of the vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝛅</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\boldsymbol{\delta}_i</annotation></semantics></math>
describes the departure from proportional hazards for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mtext mathvariant="normal">th</mtext></mrow><annotation encoding="application/x-tex">s\mbox{th}</annotation></semantics></math>
covariate in the region of time associated with the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th
spline basis term. With all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>𝛅</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\boldsymbol{\delta}_i = 0</annotation></semantics></math>
the model will be the proportional hazards model. Non-proportional
hazards can be applied to any subset of the covariates if needed, or all
covariates.</p>
<p>For each covariate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>,
a hierarchical model is used for the non-proportionality effects
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>δ</mi><mrow><mi>k</mi><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">\delta_{ks}</annotation></semantics></math>.
This model “partially pools” the effects from different regions of time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
either via an exchangeable model,</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>δ</mi><mrow><mi>i</mi><mi>s</mi></mrow></msub><mo>∼</mo><mi>N</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>l</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>τ</mi><mi>s</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex"> \delta_{is} \sim Normal(0, \tau_s^2) </annotation></semantics></math></p>
<p>or a normal second-order random walk model, like the one used for the
basis coefficients. In the non-proportional hazards model, the ratio
between the hazards
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>𝐱</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t,\boldsymbol{x})</annotation></semantics></math>
at different covariate values
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐱</mi><annotation encoding="application/x-tex">\boldsymbol{x}</annotation></semantics></math>
is a function of time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
Since the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝛅</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\boldsymbol{\delta}_i</annotation></semantics></math>
may be arbirtarily different in each region of time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
the hazard ratio can be an arbitrarily-flexible function of time. The
amount and shape of non-proportionality is estimated from the data,
while the hierarchical model protects against overfitting.</p>
</div>
</div>
<div class="section level2">
<h2 id="cure_methods">Cure models<a class="anchor" aria-label="anchor" href="#cure_methods"></a>
</h2>
<p>The <code>survextrap</code> package implements a mixture cure version
of the M-spline model.</p>
<p>In a mixture cure model, the survival is defined by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>p</mi><mo>,</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>p</mi><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>S</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S(t | p, \boldsymbol{\theta}) = p + (1-p)S_0(t|\boldsymbol{\theta})</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
is sometimes termed the “cure probability”, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>𝛉</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S_0(t|\boldsymbol{\theta})</annotation></semantics></math>
is a parametric model with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝛉</mi><annotation encoding="application/x-tex">\boldsymbol{\theta}</annotation></semantics></math>,
termed the “uncured survival”. In <code>survextrap</code>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mn>0</mn></msub><annotation encoding="application/x-tex">S_0</annotation></semantics></math>
is the M-spline model.</p>
<p>This model can be interpreted in two different ways:</p>
<ul>
<li><p>as a mixture model, where a person has hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>1</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">h_1(t)=0</annotation></semantics></math>
at all times
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
with probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>,
or hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_0(t)</annotation></semantics></math>
at all times with probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mi>p</mi></mrow><annotation encoding="application/x-tex">1-p</annotation></semantics></math>.</p></li>
<li><p>as a model where everyone follows the same hazard function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t) = f(t)/S(t)</annotation></semantics></math>,
where the PDF is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>f</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(t) = (1-p)f_0(t)</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f_0(t)</annotation></semantics></math>
is the PDF of the “uncured” parametric model. Hence
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>p</mi><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>S</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t) = f_0(t) / (p/(1-p) + S_0(t))</annotation></semantics></math>,
which asymptotically decreases towards zero with increasing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
(as long as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">p&gt;0</annotation></semantics></math>).</p></li>
</ul>
<p>Since we cannot observe whether censored observations are part of the
“cured” subgroup, these interpretations are indistinguishable in
practice.</p>
</div>
<div class="section level2">
<h2 id="relsurv_methods">Relative survival / additive hazards models<a class="anchor" aria-label="anchor" href="#relsurv_methods"></a>
</h2>
<p><code>survextrap</code> also implements a model where the overall
hazard is assumed to be the sum of two components corresponding to
different causes of death. These are usually termed the “background”
hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_b(t)</annotation></semantics></math>
and the “cause-specific” or “excess” hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>c</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_c(t)</annotation></semantics></math>,
so that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>h</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>h</mi><mi>c</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t) = h_b(t) + h_c(t)</annotation></semantics></math>,
where:</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_b(t)</annotation></semantics></math>
is assumed to be a known, piecewise-constant (step) function, and is
provided by the user in a data frame that gives the background hazard in
each of a series of time periods. See <a href="examples.html#relsurv_examples">the examples</a>.</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>c</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_c(t)</annotation></semantics></math>
follows the standard flexible parametric (M-spline) model used in
<code>survextrap</code>.</p></li>
</ul>
<p>This is known as a “relative survival” model, since the additive
model for the hazards implies a multiplicative model for survival:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>S</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>S</mi><mi>c</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S(t) = S_b(t)S_c(t)</annotation></semantics></math>.
This kind of model is often used when the background hazard is
confidently known (from national statistics on general mortality) and
the cause-specific hazard can be inferred from the individual-level
data.</p>
<p>The model used in <code>survextrap</code> is a variant of the model
by <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.3064" class="external-link">Nelson
et al</a> and should give similar results. The only difference is that
the model in <code>survextrap</code> is Bayesian, and a different kind
of spline is used.</p>
<div class="section level4">
<h4 id="combining-relative-survival-and-cure-models">Combining relative survival and cure models<a class="anchor" aria-label="anchor" href="#combining-relative-survival-and-cure-models"></a>
</h4>
<p>To use a cure model and a relative survival model together,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>c</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_c(t)</annotation></semantics></math>
is defined by a mixture cure version of the M-spline model, and a
background hazard data set is supplied to define
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_b(t)</annotation></semantics></math>.
This allows the overall hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t)</annotation></semantics></math>
to decrease asymptotically towards a background hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>b</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h_b(t)</annotation></semantics></math>,
instead of decreasing towards zero.</p>
<p>This model is appropriate if we are sure that people with the disease
are eventually “cured”, or alternatively, their risk from the disease
becomes negligible compared to their risk of death from other causes,
and we have good information about general mortality and when this
starts to dominate. Therefore average survival is estimated by naturally
combining short-term information on disease-specific survival with
long-term data on general mortality.</p>
</div>
</div>
<div class="section level2">
<h2 id="waning">Treatment effect waning models<a class="anchor" aria-label="anchor" href="#waning"></a>
</h2>
<div class="section level4">
<h4 id="principles">Principles<a class="anchor" aria-label="anchor" href="#principles"></a>
</h4>
<p>Suppose we have short-term data, say from a trial of a treatment
against a control. The trial data is assumed to be representative of the
treatment effect in the short term. We may also have long-term data that
gives information about the survival in the control group. However we do
not believe that the effect of the treatment will continue. In the long
term, we suppose the treatment effect “wanes” or diminishes, so that
over time the treatment and control group will have similar risks.</p>
<p>How is this done in <code>survextrap</code>? Essentially:</p>
<ul>
<li><p>We fit a <code>survextrap</code> (M-spline) model that combines
the short-term data with the long-term data on the control group. From
this model, we estimate the short-term treatment effect (e.g. with a
proportional hazards model), and the long-term survival in the control
group.</p></li>
<li><p>However, we do not want to use the model directly to estimate
long-term survival in the treatment group, because it relies on the
assumption that the hazard ratio in the short term continues in the
longer term. Instead, to predict long-term survival in the <em>treatment
group</em> we assume that the treatment effect <em>wanes</em> over some
time interval from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">t_{min}</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><annotation encoding="application/x-tex">t_{max}</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">t_{min}</annotation></semantics></math>
is after the follow-up period of the trial.</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="waning-model-details">Waning model: details<a class="anchor" aria-label="anchor" href="#waning-model-details"></a>
</h4>
<p>Specifically, to predict the long-term hazard
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t | x=1)</annotation></semantics></math>
in the treated group, we assume:</p>
<ul>
<li><p>Between time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">t=0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t=t_{min}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t | x=1)</annotation></semantics></math>
is equal to the hazard in the treated group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x=1</annotation></semantics></math>,
estimated from the model.</p></li>
<li><p>After time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t=t_{max}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t | x=1)</annotation></semantics></math>
is equal to the hazard in the control group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t | x=0)</annotation></semantics></math>,
estimated from the model.</p></li>
<li>
<p>During the interval between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t = t_{min}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t = t_{max}</annotation></semantics></math>,
the log hazard ratio
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mo stretchy="false" form="prefix">(</mo><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mrow><mo stretchy="true" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(hr(t)) = \log(h(t|x=1) | h(t|x=0))</annotation></semantics></math>
diminishes linearly between the log hazard ratio
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(hr(t_{min}))</annotation></semantics></math>
at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">t_{min}</annotation></semantics></math>,
estimated from the model, and zero at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><annotation encoding="application/x-tex">t_{max}</annotation></semantics></math>.
That is,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>w</mi><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>h</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(hr(t)) = w \log(hr(t_{min}))</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>−</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>−</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">w = (t - t_{min}) / (t_{max} - t_{min})</annotation></semantics></math>.</p>
<p>Hence the predicted hazard for the treated group at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
is defined from the M-spline model as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>h</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t|x=1) = h(t | x=0) hr(t)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">h(t|x=0)</annotation></semantics></math>
comes from the fitted M-spline model.</p>
</li>
<li><p>A piecewise-constant approximation, on a fine grid, is then
imposed on the hazard within the waning period to allow easy calculation
of the cumulative hazard, survival and related quantities.</p></li>
</ul>
<p>Note that the waning assumption is implemented during
<em>prediction</em> from the fitted model, rather than as a “prior” or
structural assumption used during model fitting. The baseline log hazard
ratio at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">t_{min}</annotation></semantics></math>
is inferred from the M-spline model, short-term data and any long-term
data provided. Then when requesting predictions of, e.g., survival
curves, hazard curves or mean survival times from this fitted model, we
can optionally request that over some interval
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>,</mo><msub><mi>t</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t_{min},t_{max}</annotation></semantics></math>
the log hazard ratio for some covariate changes linearly between the
value estimated from the model and some “null” value.</p>
<p>The fitted M-spline model does not necessarily need to be a
proportional hazards model to use treatment waning. If the fitted model
is non-proportional hazards, the hazard ratio will be non-constant
between time 0 and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">t_{min}</annotation></semantics></math>,
then wane between the value at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">t_{min}</annotation></semantics></math>
and zero at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><annotation encoding="application/x-tex">t_{max}</annotation></semantics></math>.</p>
</div>
<div class="section level4">
<h4 id="waning-models-example">Waning models: example<a class="anchor" aria-label="anchor" href="#waning-models-example"></a>
</h4>
<p>For clarity here, we subset the example data to only two out of the
three treatment groups: observation-only and levamisole.</p>
<p>First we fit a <code>survextrap</code> model (arbitrarily, for this
example, an M-spline model with 5 basis terms). See the <a href="examples.html">examples vignette</a> for more examples of calling
<code>survextrap</code> function.</p>
<p>We extrapolate the survival and hazard curves up to 10 years under a
naive assumption of proportional hazards beyond the end of follow-up (3
years).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="va">colons2</span> <span class="op">&lt;-</span> <span class="va">colons</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span>, <span class="st">"Lev"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rxph_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">rx</span>, data<span class="op">=</span><span class="va">colons2</span>, </span>
<span>                       fit_method<span class="op">=</span><span class="st">"opt"</span>, mspline<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxph_mod</span>, tmax<span class="op">=</span><span class="fl">10</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>To predict from this model under a waning treatment effect we must
define the following:</p>
<ul>
<li><p><code>wane_period</code>: a vector containing the start and end
of the period over which the effect wanes</p></li>
<li><p><code>newdata</code>: the covariate values that define the hazard
under the “full” effect (before waning starts)</p></li>
<li><p><code>newdata0</code>: the covariate values that define the
hazard under the “null” effect (after waning finishes)</p></li>
</ul>
<p>Optionally we can also supply <code>wane_nt</code>, which defines the
number of intervals to use for the grid approximation to the hazard
within the waning period. This defaults to 10, which I’d expect to be
sufficient in practice.</p>
<p>These things are supplied as arguments to the functions
<code>survival</code>, <code>hazard</code> and <code>rmst</code>, and
the <code>plot</code> and <code>mean</code> methods for survextrap
objects.</p>
<p>In this example, we predict the survival and hazard over 10 years for
the treated and control groups. The treated group is assumed to
experience treatment effect waning - so that between 5 and 10 years,
their log hazard changes linearly between the modelled hazard of the
treated group and the modelled hazard of the control group.</p>
<p>To obtain predictions for both groups, we first define the “full” and
“null” covariate values, as data frames with two rows, one for the
treated group and one for the control group. Note for the control group,
the “full” and “null” covariate values are the same.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lev"</span>,<span class="st">"Obs"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nd_null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span>,<span class="st">"Obs"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then supply these as arguments to the <code>plot</code> method,
along with a definition of the waning period (5 to 10 years), to
illustrate the survival and hazard trajectories for each group under
this waning model. Note how the hazard curves converge over the waning
period. The survival curves have only just started to converge - the
effects of the waning on survival would be more noticeable over longer
extrapolation periods (say 30-40 years).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxph_mod</span>, tmax<span class="op">=</span><span class="fl">10</span>, wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, niter<span class="op">=</span><span class="fl">1000</span>, </span>
<span>     newdata <span class="op">=</span> <span class="va">nd_full</span>, newdata0 <span class="op">=</span> <span class="va">nd_null</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>We also compare the restricted mean survival times (up to 50 years)
with and without treatment waning. The consequence of the waning
treatment effect is to reduce this long term mean survival time under
the treated group by about three years. (Combining waning with
computation of the restricted mean is computationally intensive, so in
this illustration, we only use a sample of 20 from the posterior
distribution).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t<span class="op">=</span><span class="fl">50</span>, niter<span class="op">=</span><span class="fl">100</span>, newdata<span class="op">=</span><span class="va">nd_full</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">##   variable rx        t median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst     Lev      50   8.25  4.29  20.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst     Obs      50   4.95  3.06  12.3</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t<span class="op">=</span><span class="fl">50</span>, niter<span class="op">=</span><span class="fl">20</span>, newdata<span class="op">=</span><span class="va">nd_full</span>, newdata0<span class="op">=</span><span class="va">nd_null</span>, wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">##   variable rx        t median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst     Lev      50   7.22  4.34  22.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst     Obs      50   4.88  3.46  15.8</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="waning-models-distribution-utilities">Waning models: distribution utilities<a class="anchor" aria-label="anchor" href="#waning-models-distribution-utilities"></a>
</h4>
<p>Distribution and random number generation functions for the “waning
effect” model are available as <code><a href="../reference/Survmspline_wane.html">psurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">Hsurvmspline_wane()</a></code>, <code><a href="../reference/Survmspline_wane.html">hsurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">dsurvmspline_wane()</a></code>, <code><a href="../reference/Survmspline_wane.html">qsurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">rsurvmspline_wane()</a></code>, to enable users to construct other
summaries or predictions from this model.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
