<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="survextrap">
<title>Details of methods behind survextrap • survextrap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Details of methods behind survextrap">
<meta property="og:description" content="survextrap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a>
    <a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a>
    <a class="dropdown-item" href="../articles/waning.html">Treatment effect waning in survextrap</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Details of methods behind survextrap</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2022-12-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/methods.Rmd" class="external-link"><code>vignettes/methods.Rmd</code></a></small>
      <div class="d-none name"><code>methods.Rmd</code></div>
    </div>

    
    
<p>See the <a href="../index.html">README</a> for the design principles
of the package, and the <a href="examples.html">examples vignette</a>
for examples of how to fit models.</p>
<p>It is work in progress, so it will be sketchy in some places.</p>
<div class="section level2">
<h2 id="m-splines">M-splines<a class="anchor" aria-label="anchor" href="#m-splines"></a>
</h2>
<p>The axis of time is split into a set of regions defined by
<em>knots</em>. In the example below, the knots are located at the
integers from 0 to 10, as shown by the grid lines.</p>
<p>Each region is associated with a <em>cubic polynomial function</em>
<span class="math inline">\(b_k(t)\)</span>, known as a <em>basis</em>
function. M-spline basis functions are defined to be positive.</p>
<p>In this example, there are 11 basis functions in the interior of the
space. Each basis function has a peak around the knot, and diminishes to
zero on either side. Two additional basis functions are used with peaks
at the boundaries of the space, so there are <span class="math inline">\(K=13\)</span> basis functions in total. See <a href="https://www.jstor.org/stable/2245395" class="external-link">Ramsay</a> for the exact
definitions of <span class="math inline">\(b_k(t)\)</span>.</p>
<p>The hazard <span class="math inline">\(h(t)\)</span> at time <span class="math inline">\(t\)</span> is defined by a <em>weighted sum</em>
of the basis functions:</p>
<p><span class="math display">\[h(t) = \eta \sum_k p_k
b_k(t)\]</span></p>
<p>with</p>
<ul>
<li><p>weights <span class="math inline">\(p_1,\ldots,p_K\)</span> that
sum to 1, <span class="math inline">\(\sum_k p_k = 1\)</span>, known as
the <em>basis coefficients</em>.</p></li>
<li><p>a <em>scale</em> parameter <span class="math inline">\(\eta\)</span> that describes the average level of
the hazard.</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">p_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">13</span>, <span class="fl">13</span><span class="op">)</span></span>
<span><span class="va">p_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_uniform_weights.html">mspline_uniform_weights</a></span><span class="op">(</span>iknots<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, bknots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">haz_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_plotdata.html">mspline_plotdata</a></span><span class="op">(</span>df<span class="op">=</span><span class="fl">13</span>, scale<span class="op">=</span><span class="fl">10</span>, coefs <span class="op">=</span> <span class="va">p_const</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>df<span class="op">=</span><span class="fl">13</span>, scale<span class="op">=</span><span class="fl">10</span>, coefs <span class="op">=</span> <span class="va">p_naive</span>, tmax<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, data<span class="op">=</span><span class="va">haz_unif</span>, color<span class="op">=</span><span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">2</span>, y<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"h(t): weights `p_const`"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">1.5</span>, y<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"h(t): weights `p_naive`"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time t"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard rate"</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="using-m-splines-to-represent-particular-hazard-shapes">Using M-splines to represent particular hazard shapes<a class="anchor" aria-label="anchor" href="#using-m-splines-to-represent-particular-hazard-shapes"></a>
</h2>
<p>The weights <span class="math inline">\(p_k\)</span> define how the
hazard changes through time. If knots are equally spaced, then <span class="math inline">\(p_k\)</span> are nearly proportional to the hazard
in the <span class="math inline">\(k\)</span>th region, so that if all
<span class="math inline">\(p_k\)</span> are equal, then the hazard is
nearly constant (red line <code>p_equal</code> in the figure). It is not
exactly constant because of the influence of the regions at either end
of the space, whose polynomial functions have a skewed shape.</p>
<p>To produce a practically constant hazard, we can search numerically
for the <span class="math inline">\(p_k\)</span> which minimise the
variance of a selection of points <span class="math inline">\(t\)</span>
that span the area that we want to model. This search can be done
automatically in the package (red line <code>p_const</code> in the
figure).</p>
<p><strong>Extrapolation?</strong> To fully specify a parametric
time-to-event model, we have to define the hazard for times greater than
the time <span class="math inline">\(t_{K}\)</span> of the highest knot,
which is 10 in the example.</p>
<p>The model in <code>survextrap</code> simply assumes that the hazard
for <span class="math inline">\(t &gt; t_{K}\)</span> is constant, the
same as the hazard at <span class="math inline">\(t_{K}\)</span>.</p>
<p>Therefore, if you want to estimate survival over a period where you
think the hazard might not be constant, then you should make sure that
the highest spline knot <span class="math inline">\(t_K\)</span> is
after the end of this period.</p>
<p>(<em>Sidenote</em>. Another way to define the hazard beyond the last
knot would be to extrapolate the final basis polynomials, but this is
not implemented. Although it would lead to a more smoothly extrapolated
hazard, it would be driven by data just before the boundary, and would
be making opaque assumptions about how the hazard changes after the
boundary. The idea behind the package is to make all assumptions
explicit as data or mechanisms. Perhaps a better approach would be to
make the function smooth at the final knot but still constant after
then, somehow).</p>
<p>Examples of doing this with different kinds of data and knowledge are
given in <code><a href="../articles/examples.html">vignette("examples")</a></code>.</p>
<p>Another arbitrary example of an M-spline curve:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>iknots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">5</span><span class="op">)</span>, bknots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>     coefs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>, tmax<span class="op">=</span><span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 3731 rows containing missing values (`geom_line()`).</span></span>
<span><span class="co">## Removed 3731 rows containing missing values (`geom_line()`).</span></span></code></pre>
<p><img src="methods_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="section level3">
<h3 id="why-not-other-kinds-of-spline">Why not other kinds of spline?<a class="anchor" aria-label="anchor" href="#why-not-other-kinds-of-spline"></a>
</h3>
<ul>
<li><p>The Royston/Parmar model (e.g. in flexsurv) uses a natural cubic
spline for the log cumulative hazard function. A cumulative hazard is
defined to be a non-decreasing function, but the spline is not
constrained. The constraint is handled during fitting the model - spline
coefficients which imply decreasing cumulative hazard functions are
rejected. This is inefficient. A worse problem for Bayesian analysis of
this model is that it is unclear how to specify priors - a meaningful
joint prior on the coefficients would have to rule out invalid
combinations.</p></li>
<li><p>We could also have placed an unrestricted spline, of any kind, on
the log hazard. The disadvantage with this is that the cumulative hazard
(required to obtain the likelihood for censored data) then has to be
evaluated by numerical integration, which is slow.</p></li>
<li><p>The advantage of putting an M-spline on the hazard is that it
respects the constraint that a hazard has to be non-negative, while it
can be integrated analytically to produce the cumulative
hazard.</p></li>
<li><p>A remaining disadvantage of M-splines is that they still rely on
a choice of knot locations. We hope to show that this does not matter
much. Suggestions of alternative model families are welcome. Gaussian
processes, perhaps? Though these are conceptually much harder. Does the
GLM framework (<a href="https://doi.org/10.1177%2F0272989X19873661" class="external-link">Kearns et al</a>) make
it easier to compute likelihoods for arbitrarily flexible models (at the
cost of a discrete-time approximatinion to the hazard)?</p></li>
<li><p>I’d assume there is no difference between different kinds of
arbitrarily-flexible model (fractional polynomials, particular kinds of
spline) in terms of how well they tend to fit observed data, because
they are all designed to do that job very well. The difference I think
will be in their computational efficiency, and how easily we can devise
clearly-understandable priors on their parameters. Priors will be
influential in the places where there are no data. For extrapolation, we
don’t want to rely on opaque nuances of the functional forms used in
specific model families.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="bayesian-model-specification">Bayesian model specification<a class="anchor" aria-label="anchor" href="#bayesian-model-specification"></a>
</h2>
<p>The <em>parameters</em> of the model, <span class="math inline">\(p_k\)</span> and <span class="math inline">\(\eta\)</span>, are estimated from data using
Bayesian inference.</p>
<p>The <em>flexibility</em> of the fitted model is determined by two
things.</p>
<ol style="list-style-type: lower-alpha">
<li><p>The number <span class="math inline">\(K\)</span> and choice of
knots. This determines the <em>maximum potential flexibility</em> of the
hazard function.</p></li>
<li><p>The <em>prior distribution</em> on the basis coefficients <span class="math inline">\(p_k\)</span>. This plays the role of
<em>smoothing</em> the fitted hazard function.</p></li>
</ol>
<p>The default approach taken by <code>survextrap</code> is to choose a
large number of knots <span class="math inline">\(K\)</span>, intended
to accommodate all reasonable situations, and then <em>estimate</em> the
extent of smoothing needed from the data.</p>
<ul>
<li><p>With <em>more data</em>, the fitted curve is as flexible as
necessary to represent the data.</p></li>
<li><p>With <em>less data</em>, the fit is influenced more by the
prior.</p></li>
</ul>
<p>This is a smoother, Bayesian analogue of the common approach to
spline model selection based on choosing <span class="math inline">\(K\)</span> to give the model with the lowest AIC.
It also similar in principle to the “penalised likelihood” methods
implemented in e.g. the <code>mgcv</code> and <code>rstpm2</code>
packages.</p>
</div>
<div class="section level2">
<h2 id="prior-distribution-for-the-hazard-curve">Prior distribution for the hazard curve<a class="anchor" aria-label="anchor" href="#prior-distribution-for-the-hazard-curve"></a>
</h2>
<p>A log-normal prior is used for the scale <span class="math inline">\(\eta\)</span>. The default in the package is set
to to the log crude event rate plus normal(0, 20) (inspired by <a href="https://arxiv.org/pdf/2002.09633.pdf" class="external-link">rstanarm</a>) - but this can
be changed by the user.</p>
<p>A multinomial logistic distribution defines the prior for the
coefficients <span class="math inline">\(p_k\)</span> that define the
mass of the hazard in each region: <span class="math inline">\(log(p_k /
p_1) = \gamma_k\)</span>, with <span class="math inline">\(\gamma_1=0\)</span> and <span class="math inline">\(\gamma_k \sim Logistic(\mu_k, \sigma)\)</span> for
<span class="math inline">\(k = 2, \ldots, K\)</span>. This prior is
defined by:</p>
<ol style="list-style-type: lower-alpha">
<li><p><strong>Prior mean</strong>: <span class="math inline">\(\boldsymbol{\mu} = (\mu_2,\ldots,\mu_K)\)</span>.
By default, this is determined from the special set of <span class="math inline">\(p_k\)</span> that result in a <em>constant
hazard</em> <span class="math inline">\(h(t)\)</span>, REF graph
above.</p></li>
<li>
<p><strong>Prior variability</strong>: <span class="math inline">\(\sigma\)</span> controls the smoothness of the
fitted hazard curve.</p>
<ul>
<li><p>If <span class="math inline">\(\sigma=0\)</span>, then we are
certain that the hazard function is the one defined by <span class="math inline">\(\boldsymbol{\mu}\)</span>.</p></li>
<li><p>Values of <span class="math inline">\(\sigma\)</span> around 1
favour wiggly curves, such that the fitted hazard curve is driven mainly
by the the observed data.</p></li>
<li><p>For <em>very</em> high values of <span class="math inline">\(\sigma\)</span>, the hazard is dominated by a
random one of the <span class="math inline">\(K\)</span> basis
functions, which will not typically be useful in practice.</p></li>
</ul>
</li>
</ol>
<p>(<em>Sidenote</em>. This is similar to the Dirichlet distribution for
the <span class="math inline">\(p_k\)</span>, but is slightly better
behaved for estimation. While the interpretation of <span class="math inline">\(\sigma\)</span> is not completely intuitive, we
hope to show empirically that this prior works usefully well in
practice)</p>
<p>The plots below show samples from the prior distribution for the
hazard functions implied by two choices of the joint distribution for
<span class="math inline">\(\eta\)</span> and <span class="math inline">\(p\)</span>. In both, <span class="math inline">\(\eta\)</span> is log normal(0,1), which supports
hazard rates between about 0.1 and 7, and the prior mean for <span class="math inline">\(p\)</span> is the special set that is centred
around a constant hazard. The two samples differ by the choice of prior
variability. <span class="math inline">\(\sigma=0.05\)</span> is a
strong prior that forces the hazard to be nearly uniform, while <span class="math inline">\(\sigma=1\)</span> allows a wide range of wiggly
shapes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iknots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span>; <span class="va">bknots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">p_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_uniform_weights.html">mspline_uniform_weights</a></span><span class="op">(</span><span class="va">iknots</span>, <span class="va">bknots</span><span class="op">)</span></span>
<span><span class="va">prior_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">p_mean</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">p_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#prior_mean &lt;- rep(1, length(knots) + 4)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_mspline_priorpred.html">plot_mspline_priorpred</a></span><span class="op">(</span>iknots<span class="op">=</span><span class="va">iknots</span>, bknots<span class="op">=</span><span class="va">bknots</span>, tmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bknots</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span>, </span>
<span>                       prior_mean<span class="op">=</span><span class="va">prior_mean</span>, prior_sd<span class="op">=</span><span class="fl">0.05</span>, scale_sd<span class="op">=</span><span class="fl">1</span>, nsim<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">==</span><span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_mspline_priorpred.html">plot_mspline_priorpred</a></span><span class="op">(</span>iknots<span class="op">=</span><span class="va">iknots</span>, bknots<span class="op">=</span><span class="va">bknots</span>, tmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bknots</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span>, </span>
<span>                       prior_mean<span class="op">=</span><span class="va">prior_mean</span>, prior_sd<span class="op">=</span><span class="fl">1</span>, scale_sd<span class="op">=</span><span class="fl">1</span>, nsim<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 999 rows containing missing values (`geom_line()`).</span></span></code></pre>
<p><img src="methods_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>By default, the package estimates <span class="math inline">\(\sigma\)</span> as part of the full Bayesian model
(with a gamma(2,1) prior), so that uncertainty about the level of
smoothness is accounted for.</p>
<p>If sampling is poor, then this alternative procedure might work - fit
the model in two steps (“empirical Bayes”):</p>
<ol style="list-style-type: decimal">
<li><p>A “training” model fit is perfomed, where a prior is placed on
<span class="math inline">\(\sigma\)</span>, and the maximum a
posteriori estimate <span class="math inline">\(\hat\sigma\)</span> of
<span class="math inline">\(\sigma\)</span> is determined.</p></li>
<li><p>A “final” model is then fitted, in which <span class="math inline">\(\sigma\)</span> is fixed to <span class="math inline">\(\hat\sigma\)</span>, giving the “optimal” amount
of smoothness for the hazard <span class="math inline">\(h(t)\)</span>.</p></li>
</ol>
<p>Either way, these procedures still need to be tested empirically to
see whether they give sensible results. It seems to under-smooth in some
cases. Though it may not matter if the hazard function is
under-smoothed, if the purpose of the model is to estimate a quantity
that is an average over time (e.g. mean survival).</p>
<p>A sensible route to resolving these uncertainties might be use
cross-validation to assess and choose between model specifications. The
package provides an interface to the <a href="https://mc-stan.org/users/interfaces/loo" class="external-link">LOO-CV</a> method for
Bayesian cross-validation - though note that this only assesses fit to
the individual-level data, using the same principle as AIC.</p>
</div>
<div class="section level2">
<h2 id="choice-of-knots-when-modelling-data">Choice of knots when modelling data<a class="anchor" aria-label="anchor" href="#choice-of-knots-when-modelling-data"></a>
</h2>
<p>By default, internal knots are placed at the quantiles of the vector
comprising the uncensored survival times in the individual level data
and the distinct follow-up times in the external data. (Smarter
suggestions are welcome for this).</p>
<p>6 internal knots are used by default, which (with cubic polynomials)
leads to <span class="math inline">\(K=10\)</span> basis functions.</p>
<p>Users can override this default however, and use any number of knots,
placed at any position.</p>
<p>By default, the lower boundary knot is set to 0. The upper boundary
knot is set to the highest follow-up time in the data. This default
should be overridden if you want to extrapolate, and you think the
hazard might change. A sensible guide is to place the upper knot at the
latest time that you are interested in modelling. Beyond this time, you
either think the hazard will not change, or any changes in the hazard do
not matter for whatever purpose the model is used for.</p>
<p>The priors should then be chosen to give a low probability that the
hazard varies outside the range thought reasonable, e.g. in terms of
orders of magnitude. The package should provide a nice way to convert
beliefs of this kind into priors.</p>
<p>Currently, the number of knots does not depend on the absolute amount
of data - should it? With small datasets, there will be lots of knots
and very few data points between them - and we will be relying more
strongly on the prior to do the smoothing. We could assess whether this
matters by using cross-validation.</p>
<p>With external data, we want a choice of knots outside the data which
we can defend as allowing a reasonable range of shapes for the hazard
function, prior to observing the data.</p>
</div>
<div class="section level2">
<h2 id="effect-of-covariates-on-the-hazard">Effect of covariates on the hazard<a class="anchor" aria-label="anchor" href="#effect-of-covariates-on-the-hazard"></a>
</h2>
<p>In <code>survextrap</code>, the hazard may also depend on a vector of
covariates <span class="math inline">\(\boldsymbol{x}\)</span> as well
as time <span class="math inline">\(t\)</span>, and we write the hazard
as <span class="math inline">\(h(t,\boldsymbol{x})\)</span>.</p>
<div class="section level3">
<h3 id="proportional-hazards-model">Proportional hazards model<a class="anchor" aria-label="anchor" href="#proportional-hazards-model"></a>
</h3>
<p>The default model fitted is a <em>proportional hazards model</em>,
where the scale parameter <span class="math inline">\(\eta(\boldsymbol{x})\)</span> is defined as a
log-linear function of a vector of covariates <span class="math inline">\(\boldsymbol{x}\)</span>.</p>
<p><span class="math display">\[ \eta(\boldsymbol{x}) =
exp(\boldsymbol{\beta}^T \boldsymbol{x}) \]</span></p>
<p>In this model, the ratio between the hazards <span class="math inline">\(h(t,\boldsymbol{x})\)</span> at two different
values of <span class="math inline">\(\boldsymbol{x}\)</span> is
constant with respect to time <span class="math inline">\(t\)</span>.
The <em>hazard ratios</em> (i.e. between a value of 1 and 0 for each
<span class="math inline">\(\boldsymbol{x}\)</span>) are <span class="math inline">\(exp(\boldsymbol{\beta})\)</span>.</p>
</div>
<div class="section level3">
<h3 id="nonprop">Flexible, non-proportional hazards model<a class="anchor" aria-label="anchor" href="#nonprop"></a>
</h3>
<p>An alternative <em>non-proportional hazards</em> model is available.
This is achieved by also modelling the spline coefficients <span class="math inline">\(p_k\)</span> as functions of covariates, in
addition to the log-linear model on <span class="math inline">\(\eta\)</span>.</p>
<p><span class="math display">\[log(p_k(\boldsymbol{x}) /
p_1(\boldsymbol{x})) = \gamma_k(\boldsymbol{x)} \]</span></p>
<p><span class="math display">\[ \gamma_k(\boldsymbol{x)} \sim
Logistic(\mu_k + \boldsymbol{b}^{(np)T}_k \boldsymbol{x}, \sigma) \quad
(k=2,...,K), \quad b_1 = 0 \]</span></p>
<p>The <span class="math inline">\(s\)</span>th element of the vector
<span class="math inline">\(\boldsymbol{b}^{(np)}_k\)</span> describes
the departure from proportional hazards for the <span class="math inline">\(s\mbox{th}\)</span> covariate in the region of
time associated with the <span class="math inline">\(k\)</span>th spline
basis term. With all <span class="math inline">\(\boldsymbol{b}^{(np)}_k
= 0\)</span> the model will be the proportional hazards model.
(Currently in the package, either all covariates or none have to have
proportional hazards).</p>
<p>For each covariate <span class="math inline">\(s\)</span>, a
hierarchical model is used for the non-proportionality effects <span class="math inline">\(b^{(np)}_{ks}\)</span>. This model “partially
pools” the effects from different regions of time <span class="math inline">\(k\)</span>.</p>
<p><span class="math display">\[ b^{(np)}_{ks} \sim Normal(0,
\sigma^{(np)}_s) \]</span></p>
<p>In the non-proportional hazards model, the ratio between the hazards
<span class="math inline">\(h(t,\boldsymbol{x})\)</span> at different
covariate values <span class="math inline">\(\boldsymbol{x}\)</span> is
a function of time <span class="math inline">\(t\)</span>. Since the
<span class="math inline">\(\boldsymbol{b}^{(np)}_k\)</span> may be
arbirtarily different in each region of time <span class="math inline">\(k\)</span>, the hazard ratio can be an
arbitrarily-flexible function of time. The amount and shape of
non-proportionality is estimated from the data, while the hierarchical
model protects against overfitting.</p>
</div>
<div class="section level3">
<h3 id="treatment-effect-waning-models">Treatment effect waning models<a class="anchor" aria-label="anchor" href="#treatment-effect-waning-models"></a>
</h3>
<p>These are described in <a href="waning.html">their own
vignette</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="cure_methods">Cure models<a class="anchor" aria-label="anchor" href="#cure_methods"></a>
</h2>
<p>The <code>survextrap</code> package implements a mixture cure version
of the M-spline model.</p>
<p>In a mixture cure model, the survival is defined by <span class="math inline">\(S(t | p, \boldsymbol{\theta}) = p +
(1-p)S_0(t|\boldsymbol{\theta})\)</span>, where <span class="math inline">\(p\)</span> is sometimes termed the “cure
probability”, and <span class="math inline">\(S_0(t|\boldsymbol{\theta})\)</span> is a
parametric model with parameters <span class="math inline">\(\boldsymbol{\theta}\)</span>, termed the “uncured
survival”. In <code>survextrap</code>, <span class="math inline">\(S_0\)</span> is the M-spline model.</p>
<p>This model can be interpreted in two different ways:</p>
<ul>
<li><p>as a mixture model, where a person has hazard <span class="math inline">\(h_1(t)=0\)</span> at all times <span class="math inline">\(t\)</span> with probability <span class="math inline">\(p\)</span>, or hazard <span class="math inline">\(h_0(t)\)</span> at all times with probability
<span class="math inline">\(1-p\)</span>.</p></li>
<li><p>as a model where everyone follows the same hazard function <span class="math inline">\(h(t) = f(t)/S(t)\)</span>, where the PDF is <span class="math inline">\(f(t) = (1-p)f_0(t)\)</span>, and <span class="math inline">\(f_0(t)\)</span> is the PDF of the “uncured”
parametric model. Hence <span class="math inline">\(h(t) = f_0(t) /
(p/(1-p) + S_0(t))\)</span>, which asymptotically decreases towards zero
with increasing <span class="math inline">\(t\)</span> (as long as <span class="math inline">\(p&gt;0\)</span>).</p></li>
</ul>
<p>Since we do not observe whether a person is part of the “cured”
subgroup, these interpretations are indistinguishable in practice.</p>
</div>
<div class="section level2">
<h2 id="relsurv_methods">Relative survival / additive hazards models<a class="anchor" aria-label="anchor" href="#relsurv_methods"></a>
</h2>
<p><code>survextrap</code> also implements a model where the overall
hazard is assumed to be the sum of two components corresponding to
different causes of death. These are usually termed the “background”
hazard <span class="math inline">\(h_b(t)\)</span> and the
“cause-specific” or “excess” hazard <span class="math inline">\(h_c(t)\)</span>, so that <span class="math inline">\(h(t) = h_b(t) + h_c(t)\)</span>, where:</p>
<ul>
<li><p><span class="math inline">\(h_b(t)\)</span> is assumed to be a
known, piecewise-constant (step) function, and is provided by the user
in a data frame that gives the background hazard in each of a series of
time periods. See <a href="examples.html#relsurv_examples">the
examples</a>.</p></li>
<li><p><span class="math inline">\(h_c(t)\)</span> follows the standard
flexible parametric (M-spline) model used in
<code>survextrap</code>.</p></li>
</ul>
<p>This is known as a “relative survival” model, since the additive
model for the hazards implies a multiplicative model for survival: <span class="math inline">\(S(t) = S_b(t)S_c(t)\)</span>. This kind of model
is often used when the background hazard is confidently known (from
national statistics on general mortality) and the cause-specific hazard
can be inferred from the individual-level data.</p>
<p>The model used in <code>survextrap</code> is a variant of the model
by <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.3064" class="external-link">Nelson
et al</a> and should give similar results. The only difference is that
the model in <code>survextrap</code> is Bayesian, and a different kind
of spline is used.</p>
<div class="section level4">
<h4 id="combining-relative-survival-and-cure-models">Combining relative survival and cure models<a class="anchor" aria-label="anchor" href="#combining-relative-survival-and-cure-models"></a>
</h4>
<p>To use a cure model and a relative survival model together, <span class="math inline">\(h_c(t)\)</span> is defined by a mixture cure
version of the M-spline model, and a background hazard data set is
supplied to define <span class="math inline">\(h_b(t)\)</span>. This
allows the overall hazard <span class="math inline">\(h(t)\)</span> to
decrease asymptotically towards a background hazard <span class="math inline">\(h_b(t)\)</span>, instead of decreasing towards
zero.</p>
<p>This model is appropriate if we are sure that people with the disease
are eventually “cured”, or alternatively, their risk from the disease
becomes negligible compared to their risk of death from other causes,
and we have good information about general mortality and when this
starts to dominate. Therefore average survival is estimated by naturally
combining short-term information on disease-specific survival with
long-term data on general mortality.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
